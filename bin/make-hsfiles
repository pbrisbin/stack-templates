#!/bin/sh
set -e

if [ $# -lt 2 ]; then
  echo "usage: make-hsfiles NAME SOURCE" >&2
  exit 64
fi

dest=$1.hsfiles
source=$2
file_list=$(mktemp)
trap 'rm $file_list' EXIT

find "$source" -type f | sort > "$file_list"

while read -r file; do
  relative=${file/$source\//}
  printf "Adding %s to %s...\n" "$relative" "$dest"
  printf "{-# START_FILE %s #-}\n" "$relative" >> "$dest"
  cat "$file" >> "$dest"
done < "$file_list"
